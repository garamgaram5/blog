[목차](https://garamgaram5.github.io/blog)    
### [ELB] HTTPS 연결하기   
   
#### ELB란?   
Elastic Load Balancer   
트래픽(부하)를 적절하게 분배해주는 장치   
트래픽(부하)를 적절하게 분배해주는 장치를 로드 밸런서라고 부름. 서버 2대 이상 가용할 때 ELB를 필수적으로 도입 함   
   
이 강의에선, ELB의 로드밸러서 기능은 사용하지 않고, ELB의 부가 기능인 SSL/TLS(HTTPS) 적용시키는 방법을 배움   
   
#### [주요 개념] SSL/TLS 이란?   
SSL/TLS 는 쉽게 표현해서 HTTP를 HTTPS로 바꿔주는 인증서   
ELB는 SSL/TLS 기능을 제공함. SSL/TLS 인증서를 활용해 HTTP가 아닌 HTTPS 로 통신할 수 있게 만들어 줌   
   
#### HTTPS?   
HTTPS를 적용하는 이유   
- 보안적 이유: 데이터를 서버와 주고받을 때 암호화 시켜서 통신. 암호화 하지 않으면 누군가 중간에서 데이터를 가로채서 해킹하는 리스크   
- 사용자 이탈: 브라우저에서 HTTPS 적용하지 않았다는 경고 메세지, 신뢰가지 않는 사이트로 보여 사용자 이탈 리스크   
   
#### 현업에서?   
대부분의 웹 사이트에서 HTTPS를 적용시킨다   
   
HTTPS 인증을 받은 웹사이트가 백엔드 서버와 통신하려면, 백엔드 서버의 주소도 HTTPS 인증을 받아야 함   
따라서 백엔드 서버와 통신할 때도 IP주소가 아닌 HTTPS 인증을 받은 도메인 주소로 통신 함   
(예) 도메인 주소를 주로 아래와 같이 구성   
웹 사이트 주소: https://jscode-edu.co.kr   
백엔드 api 서버 주소: https://api.jscode-edu.co.kr   
(도메인 구매하면, .앞에 어떤 값이 붙어도 됨)   
   
#### ELB를 활용한 아키텍처   
(아키텍처 = 전체 그림)   
ELB를 사용하기 전의 아키텍처는 사용자들이 EC2의 IP 주소 또는 도메인 주소에 직접 요청을 보내는 구조   
하지만 ELB를 추가 도입함으로써 사용자들이 EC2에 직접적으로 요청을 보내지 않고 ELB를 향해 요청을 보내도록 구성   
그래서 EC2 달았던 도메인도 ELB에 달고, HTTPS도 ELB의 도메인에 적용   
   
(실습)   
#### 1. (ELB 세팅) 기본 구성   
EC2 > 로드 밸런서 > (리전 맞는지 체크 후) 로드 밸런서 생성>   
로드 밸런서 세 유형   
- Application Load Balancer <- 이거 쓸 것 (HTTP 및 HTTPS 특징을 활용한 로드밸런싱을 위해)   
- Network LB   
- Gateway LB   
(입문자는 유형 차이는 크게 중요하지 않아서 넘어감)   
   
로드 밸런서 이름: instagram-server-elb   
체계:    
- 인터넷 경계  <- 실습에 이거 씀   
- 내부 -> 프라이빗 IP 사용. VPC 배운 후에 공부 예정   
   
IP 주소 유형   
- IPv4 <- 실습에 이거 씀   
- 듀얼 스택 (IPv6 포함)   

네트워크 매핑   
로드 밸런서가 어떤 가용영역으로 보낼지 제한하는 역할   
(가용영역은 하나의 리전 안의 세부적 지역, 영역을 나눈 개념)   
모두 클릭. 가용영역에 제한 없이 분산하겠다   
   
#### 2. (ELB 세팅) 보안 그룹   
(!주의!)EC2와 ELB는 보안 그룹이 다름   
ELB도 하나의 컴퓨터, ELB의 보안 그룹 따로 설정해야 함!   
(새 텝 > EC2 > 보안 그룹 새로 만듦)   
- 인바운드 규칙: ELB로 들어오기 전에 들어와도 되는 IP 및 포트 인지 검문   
HTTP 모든 트래픽, HTTPS 모든 트래픽 (Anywhere IPv4)   
- 아웃바운드 규칙: 디폴트   
   
ELB의 보안 그룹: default 지우고, 새로 만든 보안 그룹 추가   
   
#### 3. (ELB 세팅) 리스너 및 라우팅 / 헬스 체크   
리스너: ELB로 들어온 요청을 어떤 EC2 인스턴스로 전달할 건지 설정하는 부분   

리스너 > 대상 그룹 생성 먼저!   
*대상 그룹: (AWS 용어) ELB 에 온 요청을 전달할 대상의 그룹. target group   
대상 그룹 생성 >    
기본구성: 인스턴스    
대상 그룹 이름: instagram-server-target-group   
   
ELB가 대상그룹에서 어떤 방식으로 트래픽을 전달 할지 아래애서 설정!! 
(현업에서 많이 쓰는 세팅)   
프로토콜: 포트 80   
IP 주소 유형 IPv4   
VPC: 그대로   
프로토콜 버전: HTTP1   
   
**상태 검사**
ELB의 부가 기능. 굉장히 중요한 기능!
   
상태 검사 프로토콜: HTTP   
상태 검사 경로: /health   
-> 나중에 백엔드 서버에 상태 검사용 api 만들어 줘야함   
대상 등록: 인스턴스 체크 >  80 그대로 (80번 포트에 백엔드 서버 띄워둠) > 아래에 보류중인 것으로 포함 버튼 누름   
   
리스너에 방금 만든 대상 그룹 선택   
(설정의 의미?) ELB에 HTTP를 활용해 80번 포트로 들어온 요청(트래픽)을 설정한 대상 그룹으로 전달하겠다   

나머지 디폴트 설정 > 로드 밸런서 생성   
프로비저닝 중 = 생성중   
   
헬스체크 API 추가하기   
어떻게? (코드- 수업자료 참고)   
EC2 인스턴스에 연결   
   
로드 밸런서의 특징! DNS 이름이 주소가 있고. IP가 없다   
ELB의 주소에 접속하면, EC2 인스턴스로 가서 익스프레스 백엔드 서버가 응답   
   
#### 4. ELB에 도메인 연결하기   
Route53 > 호스팅 영역 > 구입한 도메인 클릭 >    
레코드에서 EC2에 직접 연결한 레코드는 삭제 > 레코드 생성   
레코드 이름: api   
레코드 유형: A   
별칭 토글 체크!!   
트래픽 라우팅 대상: Application/Classic Load Balancer에 대한 별칭   
리전: 로드 밸런서 만든 리전   
> 로드 밸런서 선택   
나머지 디폴트로 레코드 생성   
   
#### 5. HTTPS 적용 위해 인증서 발급    
Certificate Manager 라는 서비스   
인증서 요청 >   
도메인 이름: 테스트용 도메인(api.ahnlab.tokyo)   
검증 방법   
- DNS 검증 <- 이거로 실습   
- 이메일 검증   
   
검증 대기중   
내가 과연 이 도메인의 주인인지 확인하는 절차 필요   
> Route53에서 레코드 생성 버튼 누름   
레코드 생성 후 1~3분 후 새로고침 하면 인증서 상태가 성공이 됨   
-> HTTPS 적용하기 위해 도메인에 대한 인증서 발급 완료한 것   
   
#### 6. ELB에 HTTPS 적용   
EC2 > 로드 밸런서 > 생성한 로드밸런서 > 리스너 추가   
리스너 구성: HTTPS   
HTTPS 443번 포트로 요청이 들어오면, 만들어 놓은 대상그룹으로 보내겠다의 설정   
   
**보안 정책**   
나머지 디폴트   
대상 그룹: 만들어 놓은 대상 그룹 선택    
인증서 소스: ACM에서   
인증서 선택하기    
   
아쉬운 점.. http 로도 접속 가능   
http로 온 요청을 https로 바꾸는 설정   
(방법) http 의 리스너 삭제   
새로 리스너 추가   
라우팅 액션 > URL로 리디렉션   
프로토콜: HTTPS 443
으로 리스너 생성   
   
#### 7. 비용 나가지 않게 깔끔하게 ELB 종료   
- 로드 밸런서 삭제   
- EC2 인스턴스 종료   
- 탄력적 IP 연결 해제 및 릴리즈   
(비용은 안 나가지만 지우기)   
- 인증서   
- 도메인 레코드
- 보안 그룹   
   
(보충 강의)HTTP 연결 시 ELB vs Nginx, Certbot   
   
#### 현업에서는 ELB를 활용해서 HTTPS 적용을 더 많이 함   
- HTTPS 설정이 쉬움   
- HTTPS의 인증서 만료 기간 갱신도 자동   
   
Nginx, Certbot은 저비용. 비용 절감   
   
#### (참고_보충강의)  Nginx, Certbot을 활용해 HTTPS 연결하기   
생략   